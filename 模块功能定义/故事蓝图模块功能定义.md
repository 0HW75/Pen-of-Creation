# 故事蓝图模块功能定义

## 1. 模块概述

故事蓝图模块是AI小说创作工具“创世之笔”的核心功能之一，为用户提供故事结构的规划和管理工具。该模块旨在帮助用户构建完整、合理的故事框架，通过智能辅助和可视化工具，降低故事结构规划的复杂度，提高创作效率。

## 2. 核心功能

### 2.1 大纲生成

- **AI生成**：
  - 基于项目设定和“故事模型”（英雄之旅/三幕剧等）自动生成完整大纲
  - 支持选择不同的故事模型作为生成基础
  - 支持调整生成参数，如大纲详细程度、风格倾向等

- **大纲结构**：
  - **主干情节**：故事的主要发展脉络
  - **分支情节**：围绕主干情节展开的次要情节
  - **关键事件**：推动故事发展的重要事件节点
  - **角色弧线**：主要角色的成长和变化历程
  - **主题表达**：故事核心主题的体现方式

- **大纲管理**：
  - **逐章节查看**：可展开查看各章节的大纲梗概
  - **手动调整**：支持拖拽调整章节顺序、增删章节
  - **大纲版本**：支持保存多个大纲版本，方便比较和回溯
  - **大纲导出**：支持将大纲导出为Markdown、Word等格式

- **可视化工具**：
  - **情绪/节奏曲线图**：直观展示故事的情绪变化和节奏起伏
  - **大纲树形图**：以树形结构展示大纲的层级关系
  - **故事地图**：以地图形式展示故事的空间发展

### 2.2 卷纲分解

- **自动分解**：
  - 根据大纲自动建议分卷结构
  - 基于故事长度和复杂度推荐卷数
  - 为每卷设定核心冲突和起承转合

- **卷纲结构**：
  - **卷标题**：每卷的标题和主题
  - **核心冲突**：每卷的主要冲突和矛盾
  - **起承转合**：每卷的情节结构（开端、发展、高潮、结局）
  - **关键章节**：每卷中的重要章节
  - **角色重点**：每卷中重点刻画的角色

- **卷纲管理**：
  - **拖拽调整**：支持拖拽调整卷的顺序和内容
  - **卷间衔接**：展示卷与卷之间的衔接逻辑和过渡
  - **卷纲详情**：可展开查看每卷的详细内容
  - **卷纲修改**：支持手动修改卷纲内容

- **卷纲可视化**：
  - **卷纲卡片**：以卡片形式展示每卷的核心信息
  - **卷间关系图**：展示卷与卷之间的逻辑关系
  - **卷长度分布**：展示各卷的章节数量和字数分布

### 2.3 章纲细化

- **自动分解**：
  - 根据卷纲自动分解为详细的章纲
  - 为每章设定具体的场景、出场角色和核心事件
  - 基于故事节奏自动调整章节长度和密度

- **章纲内容**：
  - **章节标题**：每章的标题
  - **场景设定**：每章发生的场景和时间
  - **出场角色**：每章出场的主要和次要角色
  - **核心事件**：每章的主要事件和情节发展
  - **情绪目标**：每章需要达到的情绪效果
  - **关键词**：每章的核心关键词和主题
  - **字数预估**：每章的预估字数

- **章纲管理**：
  - **卡片模式**：支持以卡片形式展示和管理章纲
  - **拖拽排序**：支持拖拽调整章节顺序
  - **批量操作**：支持批量修改章纲属性
  - **章纲关联**：关联章纲到相关的设定元素（角色、地点等）

- **章纲评估**：
  - **章节功能分布**：一键评估章节在故事中的功能分布（推进主线/塑造人物/设置伏笔等）
  - **节奏评估**：评估章节的节奏是否合理
  - **冲突密度**：评估章节的冲突密度是否合适
  - **角色出场**：评估角色出场是否均衡

## 3. 界面设计

### 3.1 整体布局

- **顶部导航栏**：
  - 模块标题：故事蓝图
  - 操作按钮：生成大纲、导入大纲、导出大纲
  - 视图切换：大纲视图/卷纲视图/章纲视图

- **左侧边栏**：
  - 大纲结构：以树形结构展示大纲的层级
  - 搜索框：快速搜索大纲元素
  - 筛选条件：按类型、状态等筛选

- **主内容区**：
  - 大纲编辑器（大纲视图）
  - 卷纲卡片（卷纲视图）
  - 章纲表格（章纲视图）
  - 情绪/节奏曲线图

- **右侧边栏**：
  - 相关设定：显示与当前选中大纲元素相关的设定
  - 智能建议：基于当前大纲提供AI建议
  - 操作历史：显示最近的操作记录

### 3.2 核心组件

- **大纲生成器**：
  - 故事模型选择器
  - 生成参数设置面板
  - 大纲树形编辑器
  - 情绪/节奏曲线图表

- **卷纲分解器**：
  - 卷纲卡片组件
  - 卷间关系图
  - 卷长度分布图表
  - 卷纲编辑表单

- **章纲细化器**：
  - 章纲表格组件
  - 章纲卡片组件
  - 章节功能分布图表
  - 章纲编辑表单

- **可视化工具**：
  - ECharts情绪/节奏曲线图
  - ECharts卷间关系图
  - ECharts章节功能分布图
  - React-DnD拖拽排序组件

## 4. 技术实现

### 4.1 前端实现

- **技术栈**：React + Ant Design + ECharts + React-DnD
- **核心组件**：
  - Ant Design的Tree、Card、Table组件构建大纲管理界面
  - ECharts实现各种可视化图表
  - React-DnD实现拖拽排序功能
  - 富文本编辑器用于大纲内容编辑

- **交互逻辑**：
  - 实时保存大纲变更
  - 动态更新可视化图表
  - 智能建议的实时生成和展示
  - 拖拽操作的处理和反馈

### 4.2 后端实现

- **技术栈**：Python + Flask + SQLite + OpenAI API
- **核心功能**：
  - 大纲数据的CRUD操作
  - 调用OpenAI API生成大纲
  - 故事结构分析和建议
  - 情绪/节奏曲线生成算法

- **API设计**：
  - `POST /api/ai/generate_outline`：生成故事大纲
  - `GET /api/projects/<id>/outline`：获取项目大纲
  - `POST /api/outlines`：创建新大纲
  - `PUT /api/outlines/<id>`：更新大纲
  - `DELETE /api/outlines/<id>`：删除大纲
  - `POST /api/outlines/<id>/decompose`：分解大纲为卷纲
  - `POST /api/volumes/<id>/decompose`：分解卷纲为章纲

### 4.3 数据结构

- **大纲表**：
  | 字段名 | 数据类型 | 描述 |
  |-------|---------|------|
  | id | INTEGER | 大纲ID |
  | project_id | INTEGER | 项目ID |
  | title | VARCHAR(255) | 大纲标题 |
  | content | TEXT | 大纲内容（JSON格式） |
  | story_model | VARCHAR(100) | 故事模型（英雄之旅/三幕剧等） |
  | version | INTEGER | 大纲版本号 |
  | created_at | TIMESTAMP | 创建时间 |
  | updated_at | TIMESTAMP | 更新时间 |

- **卷表**：
  | 字段名 | 数据类型 | 描述 |
  |-------|---------|------|
  | id | INTEGER | 卷ID |
  | project_id | INTEGER | 项目ID |
  | outline_id | INTEGER | 大纲ID |
  | title | VARCHAR(255) | 卷标题 |
  | content | TEXT | 卷内容（JSON格式） |
  | core_conflict | TEXT | 核心冲突 |
  | order_index | INTEGER | 排序索引 |
  | created_at | TIMESTAMP | 创建时间 |
  | updated_at | TIMESTAMP | 更新时间 |

- **章表**：
  | 字段名 | 数据类型 | 描述 |
  |-------|---------|------|
  | id | INTEGER | 章ID |
  | project_id | INTEGER | 项目ID |
  | volume_id | INTEGER | 卷ID |
  | title | VARCHAR(255) | 章标题 |
  | content | TEXT | 章内容（JSON格式） |
  | scenes | TEXT | 场景列表（JSON格式） |
  | characters | TEXT | 出场角色（JSON格式） |
  | core_event | TEXT | 核心事件 |
  | emotional_goal | TEXT | 情绪目标 |
  | keywords | TEXT | 关键词（JSON格式） |
  | word_count_estimate | INTEGER | 预估字数 |
  | order_index | INTEGER | 排序索引 |
  | created_at | TIMESTAMP | 创建时间 |
  | updated_at | TIMESTAMP | 更新时间 |

## 5. 用户流程

### 5.1 进入故事蓝图

1. 用户在项目编辑界面点击“故事蓝图”按钮
2. 系统进入故事蓝图模块
3. 显示大纲视图和当前项目的大纲内容

### 5.2 生成大纲

1. 用户点击“生成大纲”按钮
2. 用户选择故事模型（英雄之旅/三幕剧等）
3. 用户设置生成参数
4. 系统调用AI生成大纲
5. 用户查看生成的大纲内容
6. 用户对大纲进行修改和完善
7. 用户保存大纲

### 5.3 分解卷纲

1. 用户在大纲视图中点击“分解卷纲”按钮
2. 系统根据大纲自动分解为卷纲
3. 用户查看生成的卷纲内容
4. 用户对卷纲进行调整，如修改卷标题、调整卷顺序等
5. 用户为每卷设定核心冲突和起承转合
6. 用户保存卷纲

### 5.4 细化章纲

1. 用户在卷纲视图中选择一卷，点击“细化章纲”按钮
2. 系统根据卷纲自动分解为章纲
3. 用户查看生成的章纲内容
4. 用户对章纲进行调整，如修改章节标题、调整章节顺序等
5. 用户为每章设定场景、出场角色、核心事件等
6. 用户评估章节功能分布和节奏
7. 用户保存章纲

### 5.5 可视化分析

1. 用户在大纲视图中查看情绪/节奏曲线图
2. 用户分析故事的情绪变化和节奏起伏
3. 用户根据分析结果调整大纲内容
4. 系统实时更新可视化图表

## 6. 功能价值

- **结构规划**：帮助用户构建完整、合理的故事结构
- **智能辅助**：利用AI生成大纲和提供建议，降低结构规划的难度
- **可视化工具**：通过情绪/节奏曲线图等工具，直观展示故事的发展
- **效率提升**：通过自动分解和批量操作，提高故事结构规划效率
- **创作支持**：为后续的具体创作提供清晰、详细的故事框架

## 7. 未来扩展

- **故事模板**：提供不同类型的故事模板，如“玄幻小说模板”、“言情小说模板”等
- **大纲验证**：使用AI验证大纲的合理性和完整性
- **大纲协作**：支持多用户协作编辑大纲（未来版本）
- **大纲智能推荐**：基于用户的创作风格和偏好，推荐适合的大纲结构
- **多媒体大纲**：支持在大纲中嵌入图片、音频等多媒体元素

故事蓝图模块将成为用户规划故事结构的核心工具，通过AI辅助和可视化技术，帮助用户创建完整、合理、引人入胜的故事框架，为后续的具体创作提供清晰的指导。