# 实时一致性维护模块功能定义

## 1. 模块概述

实时一致性维护模块是AI小说创作工具“创世之笔”的核心功能之一，为用户提供实时的设定一致性检查和维护工具。该模块旨在帮助用户保持小说设定的一致性和连贯性，通过自动标注、实时检查和修改影响评估，减少设定矛盾和逻辑错误，提高作品质量。

## 2. 核心功能

### 2.1 自动标注

- **设定名词识别**：
  - 自动识别文本中的角色名称、地点名称、物品名称、势力名称等设定名词
  - 支持自定义设定名词的识别和标注
  - 实时更新识别结果，随文本变化而变化

- **标注显示**：
  - 使用不同颜色和样式标注不同类型的设定名词
  - 悬停显示设定名词的简要信息
  - 点击可查看设定名词的详细信息
  - 支持标注的开启/关闭

- **标注管理**：
  - 支持批量修改标注样式
  - 支持自定义标注规则
  - 支持标注历史记录

### 2.2 实时检查

- **角色一致性检查**：
  - 检查角色行为是否符合设定性格
  - 检查角色台词是否符合设定性格
  - 检查角色能力是否符合设定
  - 检查角色关系是否符合设定

- **时间线逻辑检查**：
  - 检查事件发生的时间顺序是否合理
  - 检查时间跨度是否符合逻辑
  - 检查时间描述是否一致
  - 检查时间线与设定是否冲突

- **设定冲突检查**：
  - 检查新内容是否与已有设定矛盾
  - 检查设定元素之间是否存在冲突
  - 检查设定的合理性和可行性
  - 检查设定的连贯性和一致性

- **伏笔追踪**：
  - 自动识别和标记文本中的伏笔
  - 追踪伏笔的埋设和回收情况
  - 提示未回收的伏笔
  - 检查伏笔的合理性和有效性

- **检查结果展示**：
  - 以不同颜色和图标显示检查结果（错误/警告/提示）
  - 在文本中高亮显示问题位置
  - 提供详细的问题描述和修改建议
  - 支持问题的忽略和标记

### 2.3 修改影响评估

- **影响分析**：
  - 当修改设定时，自动分析对已写内容的影响
  - 分析影响的范围和程度
  - 评估修改的风险和收益

- **受影响章节列表**：
  - 列出所有受影响的章节
  - 显示每个章节受影响的程度
  - 提供“查看详情”功能，查看具体影响
  - 支持按影响程度排序

- **批量修正建议**：
  - 为受影响的内容提供自动修正建议
  - 支持批量应用修正建议
  - 支持手动调整修正建议
  - 提供修正前后的对比

- **修改历史**：
  - 记录设定修改的历史记录
  - 追踪修改对内容的影响变化
  - 支持回滚到之前的设定版本

## 3. 界面设计

### 3.1 整体布局

- **顶部导航栏**：
  - 模块标题：实时一致性维护
  - 操作按钮：开始检查、导出报告、设置
  - 检查模式切换：实时检查/手动检查

- **左侧边栏**：
  - 检查类型：角色一致性/时间线逻辑/设定冲突/伏笔追踪
  - 问题列表：显示检查出的问题
  - 筛选条件：按问题类型、严重程度筛选

- **主内容区**：
  - 文本编辑器（显示标注和问题高亮）
  - 问题详情面板
  - 修改影响评估结果

- **右侧边栏**：
  - 相关设定：显示当前检查相关的设定
  - 修正建议：基于检查结果提供的修正建议
  - 操作历史：显示最近的检查和修改记录

### 3.2 核心组件

- **自动标注组件**：
  - 文本高亮显示组件
  - 标注样式设置面板
  - 设定名词识别配置

- **实时检查组件**：
  - 问题列表组件
  - 问题详情面板
  - 检查结果可视化图表
  - 检查参数设置面板

- **修改影响评估组件**：
  - 受影响章节列表
  - 影响程度可视化图表
  - 批量修正建议面板
  - 修改历史记录组件

## 4. 技术实现

### 4.1 前端实现

- **技术栈**：React + Ant Design + Monaco Editor + ECharts
- **核心组件**：
  - Monaco Editor实现带标注的文本编辑器
  - Ant Design的List、Card、Alert组件构建界面
  - ECharts实现影响程度可视化图表
  - Axios处理API请求

- **交互逻辑**：
  - 实时监听文本变化，触发标注和检查
  - 动态更新问题列表和修正建议
  - 处理用户对问题的操作（忽略/标记/修正）

### 4.2 后端实现

- **技术栈**：Python + Flask + SQLite + NLP库
- **核心功能**：
  - 设定名词识别和标注
  - 一致性检查算法
  - 修改影响评估算法
  - 修正建议生成

- **API设计**：
  - `POST /api/consistency/check`：执行一致性检查
  - `POST /api/consistency/analyze_impact`：分析修改影响
  - `POST /api/consistency/generate_suggestions`：生成修正建议
  - `GET /api/consistency/issues`：获取检查出的问题
  - `PUT /api/consistency/issues/<id>`：更新问题状态

### 4.3 数据结构

- **问题表**：
  | 字段名 | 数据类型 | 描述 |
  |-------|---------|------|
  | id | INTEGER | 问题ID |
  | project_id | INTEGER | 项目ID |
  | chapter_id | INTEGER | 章节ID |
  | type | VARCHAR(100) | 问题类型（角色一致性/时间线逻辑/设定冲突/伏笔追踪） |
  | severity | VARCHAR(50) | 严重程度（错误/警告/提示） |
  | description | TEXT | 问题描述 |
  | suggestion | TEXT | 修正建议 |
  | location | TEXT | 问题位置（章节+段落+行） |
  | status | VARCHAR(50) | 状态（未处理/已处理/忽略） |
  | created_at | TIMESTAMP | 创建时间 |
  | updated_at | TIMESTAMP | 更新时间 |

- **修改历史表**：
  | 字段名 | 数据类型 | 描述 |
  |-------|---------|------|
  | id | INTEGER | 修改ID |
  | project_id | INTEGER | 项目ID |
  | setting_type | VARCHAR(100) | 修改的设定类型 |
  | setting_id | INTEGER | 修改的设定ID |
  | old_value | TEXT | 修改前的值 |
  | new_value | TEXT | 修改后的值 |
  | impact_description | TEXT | 影响描述 |
  | affected_chapters | TEXT | 受影响的章节（JSON格式） |
  | created_at | TIMESTAMP | 创建时间 |

- **伏笔表**：
  | 字段名 | 数据类型 | 描述 |
  |-------|---------|------|
  | id | INTEGER | 伏笔ID |
  | project_id | INTEGER | 项目ID |
  | chapter_id | INTEGER | 埋设章节ID |
  | location | TEXT | 埋设位置 |
  | content | TEXT | 伏笔内容 |
  | recovery_chapter_id | INTEGER | 回收章节ID（可为空） |
  | recovery_location | TEXT | 回收位置（可为空） |
  | recovery_content | TEXT | 回收内容（可为空） |
  | status | VARCHAR(50) | 状态（未回收/已回收） |
  | created_at | TIMESTAMP | 创建时间 |
  | updated_at | TIMESTAMP | 更新时间 |

## 5. 用户流程

### 5.1 进入一致性维护

1. 用户在智能写作工坊模块点击“一致性维护”按钮
2. 系统进入实时一致性维护模块
3. 显示文本编辑器和一致性检查面板

### 5.2 自动标注

1. 系统自动识别文本中的设定名词
2. 系统使用不同颜色标注不同类型的设定名词
3. 用户悬停在标注上查看简要信息
4. 用户点击标注查看详细信息

### 5.3 实时检查

1. 系统实时检查文本的一致性和逻辑
2. 系统在文本中高亮显示问题位置
3. 系统在左侧边栏列出检查出的问题
4. 用户点击问题查看详细信息和修改建议
5. 用户根据建议修改文本
6. 系统实时更新检查结果

### 5.4 修改影响评估

1. 用户修改某个设定
2. 系统自动分析修改对已写内容的影响
3. 系统列出所有受影响的章节
4. 系统为受影响的内容提供修正建议
5. 用户查看影响详情和修正建议
6. 用户选择接受或调整修正建议
7. 用户应用修正建议

### 5.5 批量处理问题

1. 用户在问题列表中选择多个问题
2. 用户点击“批量处理”按钮
3. 用户选择处理方式（忽略/标记/应用修正）
4. 系统批量处理选中的问题

## 6. 功能价值

- **设定一致性**：帮助用户保持小说设定的一致性和连贯性
- **逻辑检查**：自动检查时间线逻辑和情节合理性
- **伏笔管理**：追踪伏笔的埋设和回收，确保故事完整性
- **风险评估**：评估设定修改的影响，降低修改风险
- **质量提升**：通过实时检查和修正建议，提高作品质量
- **效率提升**：减少手动检查的工作量，提高创作效率

## 7. 未来扩展

- **AI深度分析**：使用AI进行更深度的一致性分析和逻辑检查
- **自定义检查规则**：支持用户自定义检查规则和标准
- **多语言支持**：支持多语言文本的一致性检查
- **检查报告**：生成详细的一致性检查报告
- **协作检查**：支持多用户协作进行一致性检查（未来版本）

实时一致性维护模块将成为用户确保作品质量的重要工具，通过自动化的检查和评估，帮助用户避免设定矛盾和逻辑错误，创作更加严谨、连贯、高质量的小说作品。